stages:
  - ssh-publickey
  - prerequisites-install
  - install-terraform
  - deploy
  - test-ansible
  - ansible-commands
  - destroy
  
ssh-publickey:
  stage: ssh-publickey
  script: 
    - pwd
    - mkdir -p ~/.ssh
    - |
      #!/bin/bash
      FILE=~/.ssh/id_rsa
      if [ -f "$FILE" ]; then
          echo "$FILE exists."
      else 
          ssh-keygen -q -t rsa -N '' -f ~/.ssh/id_rsa 2>/dev/null <<< y >/dev/null
      fi
    
    # - sudo echo "$PRIVATEKEYNEW" | base64 -d > ~/.ssh/id_rsa
    # - chmod 400 ~/.ssh/id_rsa
    - sudo echo $PUBLICKEYNEW > ~/.ssh/gitlabnew.pub
    - chmod 400 ~/.ssh/gitlabnew.pub
    # - pwd
    # - sudo cp ~/.ssh/gitlabnew.pem /home/ec2-user/.ssh/id_rsa
    # - sudo chmod 400 /home/ec2-user/.ssh/id_rsa
    # - sudo cp ~/.ssh/gitlabnew.pub /home/ec2-user/.ssh/id_rsa.pub
  tags:
    - banuka

prerequisites-install:
  stage: prerequisites-install
  script:
    - echo "hi"
    - sudo yum update -y && sudo yum install wget unzip -y
  tags:
    - banuka

install_terraform:
  stage: install-terraform
  script:
    - export VER="0.12.9"
    - wget https://releases.hashicorp.com/terraform/${VER}/terraform_${VER}_linux_amd64.zip
    - unzip terraform_${VER}_linux_amd64.zip
    - sudo mv terraform /usr/local/bin/
    - pwd
    - rm -rf terraform_${VER}_linux_amd64.zip
    - which terraform
  tags:
    - banuka

deploy:
  stage: deploy
  script:
    - echo "" > ~/.ssh/known_hosts
    - terraform init
    - terraform plan
    - terraform apply --auto-approve
  tags:
    - banuka


test-ansible:
  stage: test-ansible  
  script:
    - pwd
  # - export ANSIBLE_HOST_KEY_CHECKING=False
    - echo "StrictHostKeyChecking no" >> /etc/ssh/ssh_config
    - cat /etc/ansible/hosts
    - cd ~/.ssh
    - ls
    - rm -rf known_hosts
    - ansible -m ping all
    - ls
  tags:
    - banuka

ansible-commands:
  stage: ansible-commands
  script:
    - echo "ansible"
    - ansible-playbook ./ansible-playbooks/copyfile.yaml
  tags:
    - banuka

# destroy:
#   stage: destroy
#   script:
#     - terraform init
#     - terraform destroy --auto-approve
#   tags:
#     - banuka

    

